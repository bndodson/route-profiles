---
title: "Route Profiles"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    logo: septa.png
    favicon: septa.png
    source_code: embed
runtime: shiny
---

```{r global, message=FALSE, warning=FALSE, include=FALSE}
library(flexdashboard)
library(dplyr)
library(ggplot2)
library(shiny)
library(leaflet)
library(rsconnect)
library(readr)
library(plotly)

OTP <- read_csv("data/OTP.csv")
Characterization <- read_csv("data/Characterization.csv")
data <- read_csv("data/data.csv")
OTP_hist <- read_csv("data/OTP_hist_long.csv")
opstats <- read_csv("data/opstats.csv")

route_selection <- '42'
plotdat <- subset(data, Route==route_selection)
OTP_plot <- subset(OTP, Route==route_selection)
highlight <- subset(opstats, Route==route_selection)
OTP_hplot <- subset(OTP_hist, Route==route_selection)
OTP_hplot$value <- round(((OTP_hplot$value)*100),0)
#OTP_hplot$id <- factor(OTP_hplot$Month, levels = OTP_hplot$Month[order(OTP_hplot$X1)])
```

Sidebar {.sidebar}
==================

```{r message=FALSE, warning=FALSE}
 selectInput("filterA", label = h4("Route:"), 
    choices = list("16" = 16, "21" = 21, "23" = 23, "42" = 42, "310" = 310, "LUCY Gold" = "LUCY GO"), 
    selected = 21) 
```
*Currently under development. For internal use only.*

*Right-click on a chart to save it as an image for use in a document or presentation.*

[Open Data](http://septaopendata-septa.opendata.arcgis.com/)

Ridership {data-icon="fa-user"}
==================

Row
-----------------------------

### Table: Total Ridership, Pass/Hr/Mi/Trip

```{r message=FALSE, warning=FALSE}
tabdat <- subset(plotdat, select = -c(X1, Route, mean_ons, mean_mph, max_load, mean_duration))
names(tabdat)[names(tabdat) == "mean_ppvh"] <- "Mean Pass. per Vehicle"
names(tabdat)[names(tabdat) == "mean_ppm"] <- "Mean Pass. per Mile"
names(tabdat)[names(tabdat) == "mean_dist"] <- "Mean Trip Distance"
names(tabdat)[names(tabdat) == "mean_pm"] <- "Mean Pass. Miles"
DT::datatable(tabdat, options = list(
  bPaginate = FALSE
))
```

### Mean Boardings and Maximum Load

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_ons, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_ons), vjust=1.6, color="white",
            position = position_stack(vjust = 0.5), size=3.5) +
  geom_line(data=plotdat, aes(x=Period, y=max_load), group=1, size=2, color='grey') +
  geom_point(data=plotdat, aes(x=Period, y=max_load, size=4, fill='black')) +
  theme_minimal() + 
  theme(legend.position = "none") +
  ggtitle("Average Boardings (Bars, Labels) + Max Load (Line)") +
  ylab("Passengers")
```

Row
----------------------------
### Passengers per Vehicle Hour

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_ppvh, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_ppvh), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  theme_minimal() + 
  theme(legend.position = "none") +
  ggtitle("Mean Passengers per Vehicle Hour") +
  ylab("Passengers")
```

### Passenger Miles

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_pm, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_pm), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  theme_minimal() + 
  theme(legend.position = "none") +
  ggtitle("Average Passenger Miles") +
  ylab("Passenger Miles per Trip")
```

Performance {data-icon="fa-clipboard-check"}
==================

Row
-----------------------------

### OTP: November 2019

```{r message=FALSE, warning=FALSE}
rate1 <- round(((OTP_plot$NOV19)*100),0)
gauge(rate1, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(85, 100), warning = c(70, 84), danger = c(0, 69)
))
```

### OTP: December 2019

```{r message=FALSE, warning=FALSE}
rate2 <- round(((OTP_plot$DEC19)*100),0)
gauge(rate2, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(85, 100), warning = c(70, 84), danger = c(0, 69)
))
```

### OTP: January 2020
```{r message=FALSE, warning=FALSE}
rate3 <- round(((OTP_plot$JAN20)*100),0)
gauge(rate3, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(85, 100), warning = c(70, 84), danger = c(0, 69)
))
```

### OTP: February 2020
```{r message=FALSE, warning=FALSE}
rate4 <- round(((OTP_plot$FEB20)*100),0)
gauge(rate4, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(85, 100), warning = c(70, 84), danger = c(0, 69)
))
```

### OTP: March 2020
```{r message=FALSE, warning=FALSE}
rate5 <- round(((OTP_plot$MAR20)*100),0)
gauge(rate5, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(85, 100), warning = c(70, 84), danger = c(0, 69)
))
```


Row
-----------------------------

### Miles per Hour

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_mph, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_mph), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  ggtitle("Mean Miles per Hour") +
  theme_minimal() + 
  theme(legend.position = "none") +
  ylab("Miles per Hour")
```

----------------------------
### Trip Duration

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_duration, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_duration), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  ggtitle("Mean Trip Duration") +
  theme_minimal() + 
  theme(legend.position = "none") +
  ylab("Minutes")
```

----------------------------
### Average Passengers per Mile

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_ppm, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_ppm), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  ggtitle("Mean Passengers per Mile") +
  theme_minimal() + 
  theme(legend.position = "none") +
  ylab("Passengers per Mile")
```

Operations {data-icon="fa-bus"}
==================

Row
-----------------------------

### OTP

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(OTP_hplot, aes(fill=category, y=value, x=Date)) + 
  geom_bar(position="stack", stat="identity") +
  geom_text(aes(label=value), color="white", size = 3, position = position_stack(vjust = 0.5)) +
  theme_minimal() + 
  ggtitle("12-month On-Time Performance") +
  ylab("Percentage") +
  scale_fill_manual(name= " ", values = c("#00BA38", "#F8766D", "#619CFF"), labels = c("% Early", "% Late", "% On-Time")) +
  scale_x_discrete(breaks=c("2019-04", "2019-06", "2019-08", "2019-10", "2019-12", "2020-02"))
```

### Passengers per Vehicle Hour

```{r message=FALSE, warning=FALSE, results='hide'}
ggplot(data=plotdat, aes(x=Period, y=mean_ppvh, fill=Period)) +
  geom_bar(stat='identity') +  
  geom_text(aes(label=mean_ppvh), vjust=1.6, color="white",
            position = position_dodge(0.9), size=3.5) +
  theme_minimal() + 
  theme(legend.position = "none") +
  ggtitle("Average Passengers per Vehicle Hour") +
  ylab("Passengers")
```

Comparison {data-icon="fa-chart-line"}
==================
Hover over a data point to learn more.

Row
-----------------------------

### Cost per Passenger
```{r message=FALSE, warning=FALSE}
a <- ggplot(data=opstats, aes(x=avg_wkdy_pax, y=cost_pp, name=Route, color=Classification)) +
  geom_point(alpha=0.8) +
  geom_point(data=highlight, aes(x=avg_wkdy_pax, y=cost_pp), color='black', size=3) +
  theme_minimal() + 
  ggtitle("Cost per Passenger") +
  ylab("Cost ($)") +
  xlab("Average Weekday Passengers")
ggplotly(a)
```

### Peak Vehicles
```{r message=FALSE, warning=FALSE}
b <- ggplot(data=opstats, aes(x=avg_wkdy_pax, y=peakv, name=Route, color=Classification)) +
  geom_point() +
  geom_point(data=highlight, aes(x=avg_wkdy_pax, y=peakv), color='black', size=3) +
  theme_minimal() + 
  ggtitle("Peak Vehilces") +
  ylab("Vehicles") +
  xlab("Average Weekday Passengers")
ggplotly(b)
```

Row
-----------------------------

### Passengers per Vehicle Hour
```{r message=FALSE, warning=FALSE}
c <- ggplot(data=opstats, aes(x=avg_wkdy_pax, y=pprh, name=Route, color=Classification)) +
  geom_point() +
  geom_point(data=highlight, aes(x=avg_wkdy_pax, y=pprh), color='black', size=3) +
  theme_minimal() + 
  ggtitle("Passengers per Revenue Hour") +
  ylab("Passengers") +
  xlab("Average Weekday Passengers")
ggplotly(c)
```

### Vehicle Miles
```{r message=FALSE, warning=FALSE}
d <- ggplot(data=opstats, aes(x=avg_wkdy_pax, y=vm, name=Route, color=Classification)) +
  geom_point() +
  geom_point(data=highlight, aes(x=avg_wkdy_pax, y=vm), color='black', size=3) +
  theme_minimal() + 
  ggtitle("Vehicle Miles") +
  ylab("Vehicle Miles") +
  xlab("Average Weekday Passengers")
ggplotly(d)
```

Map {data-icon="fa-map"}
==================
```{r message=FALSE, warning=FALSE}
routelines <- rgdal::readOGR("https://opendata.arcgis.com/datasets/cc102b601bb947c8bb947937c80e3aa5_0.geojson", verbose='FALSE')
ridership <- rgdal::readOGR("https://opendata.arcgis.com/datasets/e09e9f98bdf04eada214d2217f3adbf1_0.geojson", verbose='FALSE')

maproute <- subset(routelines, Route==42)
ridership_42 <- subset(ridership, Route==42)
ridership_42E <- subset(ridership_42, Direction == "Eastbound")
ridership_42W <- subset(ridership_42, Direction == "Westbound")


m = leaflet() %>%
  addProviderTiles(providers$CartoDB.Positron, group =  "Positron") %>%
  addPolylines(data = maproute,
               weight = 3, 
               group = "Route 42") %>%
  addCircles(data = ridership_42E,
             weight = 1, 
             color = '#8000ff',
             radius = ridership_42E$Weekday_Boards+ridership_42E$Weekday_Leaves, 
             popup = paste("Stop:", ridership_42E$Stop_Name, "<br>",
                           "Direction:", ridership_42E$Direction, "<br>",
                           "Weekday Boards:", ridership_42E$Weekday_Boards,"<br>",
                           "Weekday Leaves:", ridership_42E$Weekday_Leaves, "<br>"),
             group = "Ridership Eastbound"
  )%>%
  addCircles(data = ridership_42W,
             weight = 1, 
             color = 'royalblue',
             radius = ridership_42W$Weekday_Boards+ridership_42W$Weekday_Leaves,
             popup = paste("Stop:", ridership_42W$Stop_Name, "<br>",
                           "Direction:", ridership_42W$Direction, "<br>",
                           "Weekday Boards:", ridership_42W$Weekday_Boards, "<br>",
                           "Weekday Leaves:", ridership_42W$Weekday_Leaves, "<br>"), 
             group = "Ridership Westbound")%>%
  addLayersControl(
    overlayGroups = c("Route 42", "Ridership Eastbound", "Ridership Westbound"),
    options = layersControlOptions(collapsed = FALSE)
  )%>%
  addLegend(
    position = "bottomright",
    colors = c("royalblue", "#8000ff"), 
    labels = c("Ridership Eastbound", "Ridership Westbound")
  )


m
```
